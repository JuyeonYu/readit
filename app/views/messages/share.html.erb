<% content_for(:title) { "링크 공유 - 읽었어?" } %>

<main class="container">
  <div class="text-center">
    <h1>링크가 생성되었습니다</h1>
    <p class="subtitle">아래 링크를 복사해서 공유하세요</p>

    <div class="share-link-box">
      <code id="share-link"><%= read_message_url(@message.token) %></code>
      <button type="button" class="btn-secondary" onclick="copyLink()">복사</button>
    </div>

    <p class="hint">이 링크를 받은 사람이 메시지를 읽으면 알림을 받습니다</p>
  </div>

  <section class="message-content-section">
    <h2>메시지 내용</h2>
    <div class="message-content">
      <h3 class="message-title"><%= @message.title %></h3>
      <div class="message-body">
        <%= @message.content %>
      </div>
    </div>
  </section>

  <section class="read-events-section">
    <h2>읽음 기록</h2>
    <p class="read-summary"><strong><%= @message.unique_reader_count %></strong>명이 총 <strong><%= @message.read_count %></strong>회 읽음</p>
    <p class="read-summary-hint">* 브라우저 쿠키 기준이므로 같은 사람도 다른 기기/브라우저에서는 별도로 집계됩니다</p>

    <% if @grouped_reads.any? %>
      <ul class="read-events-list">
        <% @grouped_reads.each_with_index do |(viewer_hash, events), index| %>
          <li class="read-event-group">
            <div class="reader-header">
              <span class="reader-number">#<%= @grouped_reads.size - index %></span>
              <span class="reader-count"><%= events.size %>회 읽음</span>
            </div>
            <ul class="reader-times">
              <% events.reverse.each do |event| %>
                <li>
                  <span class="read-event-time"><%= format_datetime(event.read_at) %></span>
                  <span class="read-event-ago">(<%= time_ago_in_words(event.read_at) %> 전)</span>
                </li>
              <% end %>
            </ul>
          </li>
        <% end %>
      </ul>
    <% else %>
      <div class="empty-state">
        <p>아직 아무도 읽지 않았습니다.</p>
      </div>
    <% end %>
  </section>

  <div class="text-center">
    <%= link_to "← 홈으로", root_path, class: "btn-secondary" %>
  </div>
</main>

<script>
function copyLink() {
  const link = document.getElementById('share-link').textContent;
  navigator.clipboard.writeText(link).then(() => {
    alert('링크가 복사되었습니다');
  });
}
</script>
